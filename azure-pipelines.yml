trigger:
- main

pool:
  vmImage: 'macos-latest'
  
variables:
  buildConfiguration: 'Release'
  outputDirectory: '$(build.binariesDirectory)/$(buildConfiguration)'

stages:
- stage: BuildApps
  displayName: "Build The Apps"
  jobs:

  - job: BuildAndroid
    displayName: "Build Android App"

    steps:
      - task: NuGetToolInstaller@1

      - task: NuGetCommand@2
        inputs:
          restoreSolution: '**/*.sln'
      - task: android-manifest-version@1
        inputs:
          sourcePath: 'ep.Android/Properties/AndroidManifest.xml'
          versionCodeOption: 'buildid'
          versionCode: '$(Build.BuildId)'
          printFile: true
      - task: XamarinAndroid@1
        inputs:
          projectFile: '**/*droid*.csproj'
          outputDirectory: '$(build.binariesDirectory)'
          configuration: '$(buildConfiguration)'
          msbuildVersionOption: latest
      
      - task: AndroidSigning@3
        inputs:
          apkFiles: '**/*.apk'
          apksign: true
          zipalign: true
          apksignerKeystoreFile: '$(KeyStore-FileName)'
          apksignerKeyPassword: '$(KeyStore-Password)'
          apksignerKeystoreAlias: '$(KeyStore-Alias)'
          apksignerKeystorePassword: '$(KeyStore-Password)'
      
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: 'ep.Android\obj\Release\110\android\bin\com.companyname.testmobile.apk'
          artifactName: 'AndroidApk'

- stage: BetaVersions
  dependsOn: BuildApps
  displayName: "Beta Release"
  jobs:  
  - job: AndroidBeta
    displayName: "Release Android Beta"
    dependsOn: [BuildAndroid]
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: AndroidApk
      - task: AppCenterDistribute@3
        inputs:
          serverEndpoint: 'App Center'
          appSlug: 'EP-Mobile/EP'
          appFile: '$(Pipeline.Workspace)/com.companyname.testmobile.apk'
          symbolsOption: 'Android'
          releaseNotesOption: 'file'
          releaseNotesFile: 'releasenotes.txt'
          destinationType: 'groups'
          distributionGroupId: '0d01adb6-b2fb-4385-a9fc-2f2f7ca74d17'